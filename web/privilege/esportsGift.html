<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    @@include('html-head.html')
    <title>东赢 - 电竞、体育每月投注皆有礼，多种礼品等你领！</title>
    <link rel="stylesheet" href="/style/css/esportsGift.css">
    <script type="text/javascript" src="/style/js/lodash.js"></script>
    <script type="text/javascript" src="/style/plugins/tweenMax/TweenMax.min.js"></script>
</head>
<body>
@@include('header.html')
<div class="esports-gift-container">
    <div style="width: 1075px;margin: 0 auto;">
        <div class="title">活动礼品</div>
        <div class="progress-bar-container">
            <div class="member-bet-box">
                <div style="width: 100px;"><span class="member-valid-bet">0.00</span>元</div>
                <div class="dsj"></div>
            </div>
            <div class="progress-bar-box">
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
                <div class="progress-bar-item"></div>
            </div>
            <div class="progress-down-box">
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-small"></div>
                <div class="progress-down-item-large"></div>
                <div style="position: absolute;top: 27px;left: -1px;">0</div>
                <div style="position: absolute;right: 0;top: 27px;transform: translateX(50%);">5000000</div>
            </div>
            <div style="margin: 15px 0 25px 15px;color: #596281;">
                注：流水只统计东赢电竞/体育，IM电竞/体育，RG电竞总流水。
                <div class="exchange-btn exchange-record-btn active">兑换记录</div>
            </div>
        </div>
        <div class="gift-container">

        </div>
        <div class="title">活动时间</div>
        <div class="promo-time">2020年2月1日起</div>
        <div class="title">活动要求</div>
        <div class="promo-content-box">
            <ul class="promo-rule-list">
                <li>当月电竞/体育有效投注额：在自然月期间，电竞/体育场馆中月累计的有效投注额满足相应的领取条件即可领取对应档次的礼品一次。本活动一个月只能申请一次，如若领取成功不可更换。</li>
                <li>所有电竞/体育赔率均为欧洲盘/香港盘，且投注赔率低于1.70/0.7和无效的、取消的、同局中对冲投注将不计算在有效投注内。</li>
                <li>领取时间：活动期间内只要满足领取礼品条件，即可在活动页面自助申请礼品，如逾期没有领取视为放弃礼品。</li>
                <li>领取方式：会员在满足对应的条件后即可在活动页面点击“立即兑换”自助领取，根据页面提示填写收货人姓名、收货地址及手机号码，相关工作人员会
                    按照申请顺序进行审核，礼品的审核状态可在我的-“奖品记录”进行追踪，审核通过后东赢会依次发放礼品，礼品将在5个工作日内进行派发，实际收到
                    时间以快递公司为准。</li>
                <li>东赢仅对已结算并产生输赢结果的投注额进行计算，任何平局、取消的赛事将不计算在有效投注。</li>
                <li>每位有效玩家、每一手机号码、电子邮箱、相同银行卡、每一个IP地址、每一台电脑仅能享受一次优惠，如发现有违规者我们将保留无限期审核扣回礼品
                    及所产生的利润权利。</li>
                <li>礼品不能折算为现金，图片仅供于参考作用，礼品以实际收到的为准，东赢对礼品拥有最终解释权。</li>
                <li>此活动遵循东赢一般规则与条款。</li>
            </ul>
        </div>
    </div>
</div>
<div class="modal fade" id="giftRecordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content custom-modal-content">
            <div class="modal-header custom-modal-header">
                <h5 class="modal-title custom-modal-title">兑换记录</h5>
                <button type="button" class="close custom-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="dialog-body">
                <table class="record-table">
                    <thead>
                        <tr>
                            <th>兑换时间</th>
                            <th width="290">礼品名称</th>
                            <th>当前状态</th>
                        </tr>
                    </thead>
                    <tbody id="recordBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="giftModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content custom-modal-content">
            <div class="modal-header custom-modal-header">
                <h5 class="modal-title custom-modal-title">申请礼品</h5>
                <button type="button" class="close custom-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="giftForm" action="/ptweb/eposrts/esportsGiftExchange" novalidate="">
                    <div class="form-group">
                        <label class="col-sm-4 col-form-label">收件人：</label>
                        <div class="col-sm-8">
                            <input type="input" name="receiver" class="form-control" autocomplete="off" required data-parsley-required-message="收件人不能为空">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 col-form-label">手机号码：</label>
                        <div class="col-sm-8">
                            <input type="input" name="telephone" class="form-control" autocomplete="off" minlength="11" maxlength="11" required data-parsley-length-message="请输入11位手机号码" data-parsley-required-message="手机号码不能为空">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 col-form-label">收件地址：</label>
                        <div class="col-sm-8">
                            <textarea rows="5" cols="8" name="address" class="form-control" autocomplete="off" required data-parsley-required-message="收件地址不能为空"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="hidden" name="giftId" id="giftId">
                        <button type="reset" class="btn btn-primary" style="margin-right: 20px">重置</button>
                        <button id="giftSubmit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@@include('right-side.html')
@@include('footer.html')
</body>
@@include('html-foot.html')
<script type="text/javascript">
    var memberBet = 0;
    var alreadyGot = false;
$(function() {
    var userExist = wap_is_user_notexist();
    loadGifts();
    if(!userExist) {
        $('#giftForm').parsley(DEFAULT_PARSLEY_CONFIG);
        $('#giftForm').submit(e => {
            e.preventDefault();
            let url = $(e.target).attr("action");
            let formData = toJsonObject($(e.target).serializeArray());

            let btn = $(e.target).find("#giftSubmit");
            let text = btn.text();
            buttonDisable(btn);
            post(url, formData, event_site_host()).done(d => {
                if (d.code == 0) {
                    Swal.fire({
                        icon: 'success',
                        text: '操作成功'
                    }).then(() => {
                        location.reload();
                        $('#giftModal').modal('hide');
                        $(e.target)[0].reset()
                        $(e.target).parsley().reset();
                    });
                } else {
                    info(d.message)
                    $(e.target).parsley().reset();
                }
            }).always(() => {
                buttonEnable(btn, text);
            });
        })
    }
    var giftsList = $('.gift-container');
    function loadGifts() {
        post('/eposrts/gifts', {}, event_site_host()).done(d => {
            if (d.code == 0) {
                $.each(d.data.gifts, function(i, v) {
                    giftsList.append('<div class="gift-item-box"><div><img src="' + v.imgUrl + '"></div><div class="gift-name">' + v.giftName +'</div><div class="gift-desc">需要流水金额：' + v.requiredPoints +'</div><div class="exchange-btn" data-rpoint="' + v.requiredPoints + '" onclick="exchangeGift(' + v.id + ', ' + v.requiredPoints + ', this)">兑换礼品</div></div>');
                });
            } else {
                error(d.message);
            }
        }).then(function() {
            if(!userExist) {
                loadMemberBet();
            }
        });
    }
    function loadMemberBet() {
        post('/ptweb/eposrts/memberGiftBet', {}, event_site_host()).done(d => {
            if (d.code == 0) {
                alreadyGot = d.data.gotAlready;
                var vb = d.data.validBet;
                if(vb) {
                    memberBet = vb;
                    if(vb > 5000000)
                        vb = 5000000;
                    var leftMargin = vb/5000000*1014;
                    var startBet = {bet: 0};
                    var tween = TweenLite.to(startBet , 2, {
                        bet: vb,
                        onUpdate: showBet
                    });
                    var betSpan = $('.member-valid-bet');
                    function showBet() {
                        betSpan.text(startBet.bet.toFixed(2));
                    }
                    var mbb = $('.member-bet-box');
                    function progressItemActive() {
                        var pi = parseInt((mbb.position().left + 20)/20.3);
                        if(pi > 0) {
                            $('.progress-bar-item').slice(0, pi).addClass('active');
                        }
                    }
                    TweenMax.to(mbb, 2, {
                        x: leftMargin,
                        onUpdate: _.throttle(progressItemActive, 200)
                    });

                    //确定哪个礼品可以领取
                    var itemActive;
                    $('.gift-item-box .exchange-btn').each(function() {
                        if(memberBet >= $(this).data('rpoint')) {
                            itemActive = $(this);
                        }
                    });
                    if(itemActive) {
                        itemActive.addClass("active");
                    }
                }
            } else {
                error(d.message);
            }
        });
    }
    var recordBody = $('#recordBody');
    $('.exchange-record-btn').click(loadMemberRecords);
    function loadMemberRecords() {
        if(userExist) {
            info('请登录后操作');
        } else {
            recordBody.html("<tr><td colspan='3'>loading...</td></tr>");
            $('#giftRecordModal').modal();
            post('/ptweb/eposrts/memberGiftsList', {}, event_site_host()).done(d => {
                if (d.code == 0) {
                    recordBody.empty();
                    if(d.data.records && d.data.records.length) {
                        $.each(d.data.records, function(i, v) {
                            recordBody.append('<tr><td>' + v.date +'</td><td class="gift-name">' + v.giftName + '</td><td>' + v.status + '</td></tr>');
                        });
                    } else {
                        recordBody.html("<tr><td colspan='3'>暂无数据</td></tr>");
                    }
                }
            });
        }
    }
});
var giftBeginTime = new Date(2020, 1, 1, 0, 0, 0).getTime();
function exchangeGift(id, rp, obj) {
    if(new Date().getTime() < giftBeginTime) {
        info('活动2020年2月1日开始，敬请期待!');
    } else if(alreadyGot) {
        info('您本月已经领取过奖品，请下个月再参与');
    } else if(memberBet < rp) {
        info('兑换此礼品您还需要' + ((rp - memberBet).toFixed(2)) + '元有效投注额，请继续加油！');
    } else if(!$(obj).hasClass('active')) {
        info('只可兑换当前档礼品');
    } else {
        $('#giftForm')[0].reset();
        $('#giftForm').parsley().reset();
        $('#giftId').val(id);
        $('#giftModal').modal();
    }
}
</script>
</html>
