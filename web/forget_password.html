<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	@@include('html-head.html')
	<title>忘记密码</title>
	<link rel="stylesheet" href="/style/css/swiper.min.css">
	<link rel="stylesheet" href="/style/layui/css/layui.css">
	<link rel="stylesheet" href="/style/css/index.css">
	<link rel="stylesheet" href="/style/css/youhui.css">
	<link rel="stylesheet" href="/style/css/center.css">
	<link rel="stylesheet" href="/style/plugins/emailpop/emailpop.css">
	<script src="/style/js/jquery-3.3.1.min.js"></script>
	<script src="/style/js/jquery.validate.min.js"></script>
	<script src="/style/js/messages_zh.min.js"></script>
	<script type="text/javascript" src="/style/js/swiper.min.js"></script>
	<script src="/style/layui/layui.all.js"></script>
	<script src="/style/js/md5.js" type="text/javascript" ></script>
	<script src="/style/js/common.js" type="text/javascript" ></script>
	<script src="/style/plugins/emailpop/emailpop.js" type="text/javascript" ></script>
	<style type="text/css">
		.pTitle .a2 {
			background-color: #2e65a3;
			border-radius: 30px;
			text-align: center;
			color: #fff;
			font-size: 14px;
			padding: 2px 10px;
		}
		.vipInformation .informationBox .pif a {
			display: inline-block;
			width: 36px;
			height: 22px;
			line-height: 22px;
			border-radius: 4px;
			text-align: center;
			color: #fff;
			margin-left: 20px;
			background-color: #419641;
			cursor: pointer;
		}
		.centerContent .btnBox {
			text-align: center;
			margin-top: 20px;
			margin-bottom: 20px;
		}
        .centerContent .btnBox .layui-btn {
            width: 204px;
            height: 43px;
            line-height: 43px;
            border-radius: 30px;
            background-color: #cd4040;
            margin-right: 20px;
        }
        .centerContent .btnBox .layui-btn.b1 {
            background-color: #1b61b8;
        }
		.centerContent .layui-tab-title .layui-this{
			color: #fff;
			background-color: #1b61b8;
		}
		.centerContent .layui-tab-title .layui-this:after{
			border-width: 0px;
		}
		.centerContent .layui-tab-title li{
			margin-right: 10px;
			background-color: #b9b6b6;
			border-radius: 10px 10px 0 0;
			color: #000;
		}
		.error{ color: red;}
	</style>
</head>
<body style="background-color: #fff;">
@@include('header.html')
<div class="centerBox">
	<div class="centerContent" style="margin-top: 100px">
		<div class="layui-tab">
			<ul class="layui-tab-title" style="margin-top: -50px; margin-left: 20px">
				<li class="layui-this">手机短信找回密码</li>
				<li>邮箱找回密码</li>
				<li>忘记账号</li>
			</ul>
			<div class="layui-tab-content">
				<div class="layui-tab-item layui-show">
					<div class="centerTable">
						<fieldset class="layui-elem-field layui-field-title pTitle" style="margin-top: 20px;">
							<legend>手机短信找回密码</legend>
						</fieldset>
						<div class="layui-form" action="">
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>用户名</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="loginName_1" name="loginName" lay-verify="title" autocomplete="off"
										   class="layui-input layui-input1" required rangelength="6,12" checkLoginName="true">
									<i>XW</i>
								</div>
								<div class="layui-form-mid layui-word-aux error">注册时填写的登录用户名</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>手机</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="telephone_1" name="telephone" placeholder="" autocomplete="off"
										   class="layui-input layui-input1" required mobile="true" checkPhone="true">
									<i>+86</i>
								</div>
								<div class="layui-form-mid layui-word-aux error">注册时填写的手机号码</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>验证码</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="validCode_1" name="code"  placeholder="" autocomplete="off" class="layui-input" required>
								</div>
								<div class="layui-form-mid layui-word-aux img-code"><img src="" onclick="refreshCode()"></div>
								<input id="randomCodeId" type="hidden">
							</div>
						</div>
					</div>
					<div class="btnBox">
						<a class="layui-btn reset">重新填写</a>
						<a class="layui-btn b1"  id="submitBtn_1">确认找回</a>
					</div>
				</div>
				<div class="layui-tab-item">
					<div class="centerTable">
						<fieldset class="layui-elem-field layui-field-title pTitle" style="margin-top: 20px;">
							<legend>邮箱找回密码</legend>
						</fieldset>
						<div class="layui-form" action="">
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>用户名</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="loginName_2" name="loginName" lay-verify="title" autocomplete="off"
										   class="layui-input layui-input1" required rangelength="6,12" checkLoginName="true">
									<i>XW</i>
								</div>
								<div class="layui-form-mid layui-word-aux error">注册时填写的登录用户名</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>邮箱地址</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="mailbox_2" name="mailbox" autocomplete="off" class="layui-input" required email="true" checkMail="true">
								</div>
								<div class="layui-form-mid layui-word-aux error">注册时填写的邮件地址</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>验证码</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="validCode_2" name="code"  placeholder="" autocomplete="off" class="layui-input" required>
								</div>
								<div class="layui-form-mid layui-word-aux img-code"><img src="" onclick="refreshCode()"></div>
							</div>
						</div>
					</div>
					<div class="btnBox">
						<a class="layui-btn reset"  >重新填写</a>
						<a class="layui-btn b1"  id="submitBtn_2">确认找回</a>
					</div>
				</div>
				<div class="layui-tab-item">
					<div class="centerTable">
						<fieldset class="layui-elem-field layui-field-title pTitle" style="margin-top: 20px;">
							<legend>忘记账号</legend>
						</fieldset>
						<div class="layui-form" action="">
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>邮箱地址</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="mailbox_3" name="mailbox" autocomplete="off" class="layui-input" required email="true" checkMail="true">
								</div>
								<div class="layui-form-mid layui-word-aux error">注册时填写的邮件地址</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label"><i>*</i><span>验证码</span><em>：</em></label>
								<div class="layui-input-block">
									<input type="text" id="validCode_3" name="code"  placeholder="" autocomplete="off" class="layui-input" required>
								</div>
								<div class="layui-form-mid layui-word-aux img-code"><img src="" onclick="refreshCode()"></div>
							</div>
						</div>
					</div>
					<div class="btnBox">
						<a class="layui-btn reset">重新填写</a>
						<a class="layui-btn b1"  id="submitBtn_3">确认找回</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
@@include('right-side.html')
@@include('footer.html')
<div class="hideAll"></div>
<script type="text/javascript" src="/style/plugins/moment/moment.js"></script>
</body>
@@include('html-foot.html')
<script>
	$(function () {
        refreshCode();
        $('.reset').click(function () {
            $('.layui-tab-content input[type="text"]').val('');
        });
        $("#submitBtn_1").click(function(e){
            e.preventDefault();
            forgetPasswordByPhone();
        });

        $("#submitBtn_2").click(function(e){
            e.preventDefault();
            forgetPasswordByMail();
        });

        $("#submitBtn_3").click(function(e){
            e.preventDefault();
            forgetNameByMail();
        });
	});
	function refreshCode(){
		$.ajax({
			dataType: "jsonp",
			url: wap_site_host() + '/member/verificationCode',
			success:function(resultData){
				if(resultData.code==0){
					$('.img-code img').attr('src',resultData.data.img);
					$('#randomCodeId').val(resultData.data.id);
				}else{
					fun_alertMsg(resultData.message,function() {});
				}
			},error:function () {
				fun_alertMsg('验证码刷新失败，请稍后重试！', function() {});
			}
		});
	}

    function forgetPasswordByMail() {
        var loginName = $("#loginName_2").val().trim();
        var mailbox = $("#mailbox_2").val().trim();
        var validCode  = $('#validCode_2').val().trim();
        if (loginName.length == 0) {
            fun_alertMsg('请输入用户名！', function() {});
            return;
        } else if (mailbox.length == 0){
            fun_alertMsg('请输入注册邮箱！', function() {});
            return;
        } else if (!checkEmail(mailbox)){
            fun_alertMsg('邮箱地址不合法', function() {});
            return;
        }
        $.ajax({
            url:wap_site_host() + "/member/password",
            type:"GET",
            data:{"loginName":loginName, "mail":mailbox,"validCode":validCode},
            success:function(d){
                if (d.code == 0) {
                    fun_alertMsg('操作成功，请登录您的邮箱查看邮件', function() {
                        refreshCode();
					});
                } else {
                    fun_alertMsg(d.message, function() {});
                }
            },
            error:function(){
                fun_alertMsg('提交异常！', function() {});
            }
        });
    }

    function forgetPasswordByPhone() {
        var mobileLoginName = $("#loginName_1").val().trim();
        var mobileNum = $("#telephone_1").val().trim();
        var validCode  = $('#validCode_1').val().trim();
        var validCodeId=$('#randomCodeId').val().trim();
        if (mobileLoginName.length == 0) {
            fun_alertMsg('请输入用户名！', function () {});
            return;
        } else if (mobileNum.length == 0) {
            fun_alertMsg('请输入手机号码！', function () {
            });
            return;
        }else if (!checkMobile(mobileNum)) {
            fun_alertMsg('手机号码不合法', function () {});
            return;
        } else if (validCode.length == 0) {
            fun_alertMsg('请输入验证码！', function () {});
            return;
        }
        $.ajax({
            url:wap_site_host() + "/member/forget/forget-password-sms",
            type:"GET",
            data:{"loginName":mobileLoginName, "telephone":mobileNum,"validCode":validCode,"token":validCodeId},
            success:function(d){
                if (d.code == 0) {
                    fun_alertMsg('手机短信发送成功，请查收短信', function() {
                        refreshCode();
					});
                } else {
                    fun_alertMsg(d.message, function() {});
                }
            },
            error:function(){
                fun_alertMsg('提交异常！', function() {});
            }
        });
    }

    function forgetNameByMail() {
        var mailbox = $("#mailbox_3").val().trim();
        var validCode  = $('#validCode_3').val().trim();
		if (mailbox.length == 0){
            fun_alertMsg('请输入注册邮箱！', function() {});
            return;
        } else if (!checkEmail(mailbox)){
            fun_alertMsg('邮箱地址不合法', function() {});
            return;
        }
        $.ajax({
            url:wap_site_host() + "/member/forget-account",
            type:"GET",
            data:{ "email":mailbox,"validCode":validCode},
            success:function(d){
                if (d.code == 0) {
                    fun_alertMsg('操作成功，请登录您的邮箱查看邮件', function() {
                        refreshCode();
					});
                } else {
                    fun_alertMsg(d.message, function() {});
                }
            },
            error:function(){
                fun_alertMsg('提交异常！', function() {});
            }
        });
    }

    var checkEmail = function(email) {
        email = email || '';
        return (email.length > 3 && /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(email));
    };
    function checkMobile(phone) {
        return /^(1(([35][0-9])|(47)|(73)|(78)|(77)|(76)|[8][0123456789]))\d{8}$/.test(phone);
    }
</script>
</html>
